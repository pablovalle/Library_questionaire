<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Evaluation Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .library-card { transition: all 0.2s ease; border: 1px solid #e2e8f0; }
        .library-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .task-badge { font-size: 0.65rem; background: #f1f5f9; color: #475569; padding: 2px 6px; border-radius: 4px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="max-w-6xl mx-auto p-6">
        <header class="flex justify-between items-end mb-8 border-b pb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Library Evaluation Suite</h1>
                <p class="text-slate-500">Evaluating 150 library sets from <code class="bg-slate-200 px-1 rounded">/libraries/</code></p>
            </div>
            <div class="text-right">
                <button onclick="exportAll()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all">
                    Export All Results (.json)
                </button>
            </div>
        </header>

        <div class="mb-6">
            <input type="text" id="search" placeholder="Search library filename..." 
                   class="w-full p-3 rounded-xl border border-slate-200 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div id="loading" class="text-center py-20 text-slate-400">Loading libraries...</div>
        
        <div id="library-grid" class="grid grid-cols-1 gap-4">
            </div>
    </div>

    <script>
        const metrics = [
            { id: 1, label: "Q1: Validity", type: "number" },
            { id: 2, label: "Q2: Coverage", type: "choice" },
            { id: 3, label: "Q3: Atomicity", type: "choice" },
            { id: 4, label: "Q4: Generalizability", type: "choice" },
            { id: 5, label: "Q5: Redundancy", type: "number" },
            { id: 6, label: "Q6: Causality", type: "choice" },
            { id: 7, label: "Q7: Utility", type: "choice" }
        ];

        async function loadLibraries() {
            try {
                // 1. Fetch the list of filenames
                const listResponse = await fetch('./libraries/filelist.json');
                const filenames = await listResponse.json();
                
                const grid = document.getElementById('library-grid');
                document.getElementById('loading').remove();

                // 2. Fetch each file in the list
                for (const name of filenames) {
                    try {
                        const res = await fetch(`./libraries/${name}`);
                        const data = await res.json();
                        renderCard(name, data);
                    } catch (e) { console.error(`Could not load ${name}`); }
                }
            } catch (err) {
                document.getElementById('loading').innerHTML = "Error: filelist.json not found in /libraries/";
            }
        }

        function renderCard(filename, data) {
            const tasks = data.atomic_library || [];
            const card = document.createElement('div');
            card.className = "library-card bg-white p-5 rounded-xl flex flex-col md:flex-row gap-6 items-center";
            card.dataset.filename = filename.toLowerCase();

            const taskList = tasks.map(t => `<span class="task-badge">${t.id}</span>`).join(' ');

            let formHtml = metrics.map(m => {
                if (m.type === 'number') {
                    return `
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">${m.label.split(':')[0]}</label>
                        <input type="number" data-file="${filename}" data-qid="${m.id}" 
                               class="eval-input w-full border rounded p-1.5 text-sm">
                    </div>`;
                } else {
                    return `
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">${m.label.split(':')[0]}</label>
                        <select data-file="${filename}" data-qid="${m.id}" class="eval-input w-full border rounded p-1.5 text-sm bg-white">
                            <option value="">-</option>
                            <option value="Yes">Yes</option>
                            <option value="Partial">P</option>
                            <option value="No">No</option>
                        </select>
                    </div>`;
                }
            }).join('');

            card.innerHTML = `
                <div class="md:w-1/4 w-full">
                    <h3 class="font-bold text-slate-800 truncate">${filename}</h3>
                    <div class="mt-2 flex flex-wrap gap-1">${taskList}</div>
                </div>
                <div class="md:w-3/4 w-full grid grid-cols-4 md:grid-cols-7 gap-3">
                    ${formHtml}
                </div>
            `;
            document.getElementById('library-grid').appendChild(card);
        }

        // Search logic
        document.getElementById('search').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('.library-card').forEach(card => {
                card.style.display = card.dataset.filename.includes(val) ? 'flex' : 'none';
            });
        });

        function exportAll() {
            const results = {};
            document.querySelectorAll('.eval-input').forEach(input => {
                const f = input.dataset.file;
                if (!results[f]) results[f] = {};
                results[f][`Q${input.dataset.qid}`] = input.value;
            });
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(results, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "eval_results.json");
            dl.click();
        }

        loadLibraries();
    </script>
</body>
</html>