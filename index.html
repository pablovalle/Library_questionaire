<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Benchmark Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .task-card { border: 2px solid #e2e8f0; background: #ffffff; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .pre-tag { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; margin: 2px; display: inline-block; font-weight: 600; }
        .post-tag { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; margin: 2px; display: inline-block; font-weight: 600; }
        .param-tag { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; margin: 2px; display: inline-block; font-weight: 600; }
        .active-choice { background-color: #2563eb !important; color: white !important; border-color: #1e40af !important; }
        .num-input { font-size: 1.25rem; font-weight: 700; text-align: center; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 2% auto; padding: 40px; border-radius: 24px; width: 80%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip-text {
            visibility: hidden; width: 280px; background-color: #0f172a; color: #fff; text-align: left; border-radius: 8px; padding: 12px;
            position: absolute; z-index: 1000; bottom: 150%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.2s; font-size: 0.8rem; pointer-events: none; border: 1px solid #334155;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden font-sans text-slate-900">

    <div id="loader-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-10 text-center">
        <div id="loader-content">
            <h1 class="text-4xl font-black text-white mb-4 uppercase italic">Initializing Benchmarks</h1>
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
        </div>
        <div id="benchmark-transition" class="hidden">
            <h2 class="text-3xl font-black text-white mb-2 uppercase italic" id="trans-title">Benchmark Complete</h2>
            <p class="text-slate-400 mb-10" id="trans-msg">Updating Task References...</p>
            <button onclick="proceedToNextBenchmark()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black text-xl hover:bg-blue-500 shadow-2xl">START NEXT BENCHMARK</button>
        </div>
    </div>

    <header class="bg-white border-b px-8 py-4 flex items-center justify-between shadow-md z-20">
        <div class="flex items-center gap-6">
            <div class="bg-slate-900 text-white px-3 py-1 rounded-md text-[13px] font-black uppercase tracking-widest" id="benchmark-label">---</div>
            <div class="flex flex-col border-l pl-6 border-slate-200">
                <span id="lib-filename" class="text-blue-600 font-extrabold text-lg truncate max-w-[250px]">Loading...</span>
                <div class="flex items-center gap-3">
                    <div class="w-32 bg-slate-200 h-2 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-blue-600 h-full transition-all" style="width: 0%"></div>
                    </div>
                    <span id="progress-text" class="text-[10px] font-black text-slate-400">0 / 0</span>
                </div>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="openDataModal('simple')" class="bg-slate-800 text-white px-6 py-3 rounded-xl text-s font-black hover:bg-slate-700 uppercase tracking-tight">Show Simple Tasks</button>
            <button onclick="openDataModal('complex')" class="bg-blue-800 text-white px-6 py-3 rounded-xl text-s font-black hover:bg-blue-700 uppercase tracking-tight">Show Complex Tasks</button>
        </div>

        <button onclick="exportJSON()" class="text-sm font-black bg-slate-900 text-white px-6 py-3 rounded-xl hover:bg-emerald-600 transition-all shadow-lg uppercase">Export Final Results</button>
    </header>

    <main id="task-container" class="flex-1 overflow-y-auto p-8 scroll-smooth">
        <div id="task-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </main>

    <div id="data-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-8 border-b-4 border-slate-100 pb-4">
                <h2 id="modal-title" class="text-3xl font-black uppercase italic tracking-tighter">Reference View</h2>
                <button onclick="closeModal()" class="text-slate-300 hover:text-red-500 font-black transition-colors text-2xl">[X]</button>
            </div>
            <div id="modal-body" class="grid grid-cols-1 gap-4"></div>
        </div>
    </div>

    <footer class="bg-white border-t p-6 shadow-[0_-10px_25px_rgba(0,0,0,0.1)] z-30">
        <div class="max-w-[1800px] mx-auto flex items-stretch gap-6">
            <div id="questions-row" class="flex-1 grid grid-cols-7 gap-4"></div>
            <div class="flex flex-col gap-2 justify-center border-l pl-6 border-slate-200">
                <button id="next-btn" onclick="changeLibrary(1)" class="w-48 py-4 bg-blue-600 text-white rounded-2xl font-black hover:bg-blue-700 text-lg shadow-xl active:scale-95 transition-all">NEXT FILE</button>
                <button onclick="changeLibrary(-1)" class="w-48 py-2 border-2 border-slate-200 rounded-xl font-bold text-slate-400 text-xs uppercase hover:bg-slate-50">Previous File</button>
            </div>
        </div>
    </footer>

    <script>
        const REPO_OWNER = 'pablovalle';
        const REPO_NAME = 'Library_questionaire';
        const BASE_PATH = 'libraries';

        let benchmarkFolders = [];
        let folderIndex = 0;
        let libraryFiles = [];
        let fileIndex = 0;
        let currentComplexData = [];
        let currentSimpleData = [];
        let evaluations = JSON.parse(localStorage.getItem('eval_data')) || {};

        const metrics = [
            { id: 1, label: "Q1: Validity", type: "number", desc: "How many tasks are from the atomic task library in the ground truth?" },
            { id: 2, label: "Q2: Coverage", type: "choice", desc: "Are the generated tasks enough to compose the complex tasks?" },
            { id: 3, label: "Q3: Atomicity", type: "choice", desc: "Are the generated tasks atomic tasks?" },
            { id: 4, label: "Q4: General", type: "choice", desc: "Are all the provided tasks generic and do not rely on specific objects?" },
            { id: 5, label: "Q5: Redundancy", type: "number", desc: "Out of the tasks provided, how many tasks are repeated or equivalent?" },
            { id: 6, label: "Q6: Causality", type: "choice", desc: "Are the given preconditions and post-conditions meaningful and respect the laws of physics?" },
            { id: 7, label: "Q7: Utility", type: "choice", desc: "Is the task parameterization accurate enough for a low-level controller?" }
        ];

        async function init() {
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${BASE_PATH}`);
                const items = await res.json();
                benchmarkFolders = items.filter(i => i.type === 'dir').map(d => d.name);
                if (benchmarkFolders.length > 0) loadBenchmarkFolder(0);
            } catch (err) { console.error(err); }
        }

        async function loadBenchmarkFolder(index) {
            folderIndex = index;
            const folder = benchmarkFolders[folderIndex];
            document.getElementById('benchmark-label').innerText = folder.toUpperCase();
            
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${BASE_PATH}/${folder}`);
            const files = await res.json();
            
            libraryFiles = files.filter(f => f.name.startsWith('library') && f.name.endsWith('.json'));
            const simpleFile = files.find(f => f.name === 'simple.json');
            const complexFile = files.find(f => f.name === 'complex.json');

            if (simpleFile) currentSimpleData = await (await fetch(simpleFile.download_url)).json();
            if (complexFile) currentComplexData = await (await fetch(complexFile.download_url)).json();

            fileIndex = 0;
            document.getElementById('loader-screen').style.display = 'none';
            loadLibrary();
        }

        async function loadLibrary() {
            const file = libraryFiles[fileIndex];
            const res = await fetch(file.download_url);
            const data = await res.json();
            const tasks = data.atomic_library || [];
            
            document.getElementById('lib-filename').innerText = file.name;
            document.getElementById('progress-text').innerText = `${fileIndex + 1} / ${libraryFiles.length}`;
            document.getElementById('progress-bar').style.width = `${((fileIndex + 1) / libraryFiles.length) * 100}%`;

            document.getElementById('task-grid').innerHTML = tasks.map(t => {
                const params = t.parameters || t.params || [];
                return `
                <div class="task-card">
                    <div class="text-xl font-black text-blue-800 uppercase border-b-2 border-blue-50 pb-2">${t.id}</div>
                    <p class="text-md text-slate-600 italic mb-2 leading-relaxed font-medium">"${t.description}"</p>
                    <div class="flex-1 space-y-4">
                        <div><span class="text-[10px] font-black text-slate-400 block uppercase mb-1">Parameters</span><div class="flex flex-wrap">${params.length > 0 ? params.map(p => `<span class="param-tag">${p}</span>`).join('') : '<span class="text-xs text-slate-300 italic">None</span>'}</div></div>
                        <div><span class="text-[10px] font-black text-slate-400 block uppercase mb-1">Pre-conditions</span><div class="flex flex-wrap">${t.pre_conditions.map(c => `<span class="pre-tag">${c}</span>`).join('')}</div></div>
                        <div><span class="text-[10px] font-black text-slate-400 block uppercase mb-1">Post-conditions</span><div class="flex flex-wrap">${t.post_conditions.map(c => `<span class="post-tag">${c}</span>`).join('')}</div></div>
                    </div>
                </div>`;
            }).join('');
            const taskCount = tasks.length; // Get the count of atomic tasks
            // ... (rest of task grid rendering)
            renderQuestions(file.name, taskCount);
            document.getElementById('next-btn').innerText = (fileIndex === libraryFiles.length - 1) ? "NEXT BENCHMARK" : "NEXT FILE";
        }

        function renderQuestions(fileName, taskCount) {
            const folderName = benchmarkFolders[folderIndex];
            const saved = (evaluations[folderName] || {})[fileName] || {};
            
            document.getElementById('questions-row').innerHTML = metrics.map(m => {
                const val = saved[`Q${m.id}`] || '';
                const header = `<div class="bg-slate-200/50 py-2 border-b border-slate-100 flex items-center justify-center gap-2">
                    <label class="text-[11px] font-black text-slate-700 uppercase">${m.label}</label>
                    <div class="tooltip-container">
                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/></svg>
                        <span class="tooltip-text">${m.desc}</span>
                    </div>
                </div>`;

                if (m.type === 'number') {
                    // Check if it's Q1 (id: 1) or Q5 (id: 5) to add the total count display
                    const showTotal = (m.id === 1 || m.id === 5);
                    const totalDisplay = showTotal ? `<span class="text-xs font-black text-slate-400">/ ${taskCount}</span>` : '';
                    
                    return `
                    <div class="flex flex-col bg-slate-50 rounded-2xl border-2 border-slate-100">
                        ${header}
                        <div class="p-3 flex items-center gap-2">
                            <input type="number" min="0" max="${taskCount}" 
                                onchange="saveVal('${fileName}', ${m.id}, this.value)" 
                                value="${val}" 
                                class="num-input w-full bg-white border-2 border-slate-200 rounded-xl py-2 outline-none">
                            ${totalDisplay}
                        </div>
                    </div>`;
                } else {
                    // ... (choice button logic remains the same)
                    return `<div class="flex flex-col bg-slate-50 rounded-2xl border-2 border-slate-100">${header}<div class="p-3 flex flex-col gap-1.5">${['Yes', 'Partial', 'No'].map(opt => `<button onclick="saveVal('${fileName}', ${m.id}, '${opt}'); markActive(this)" class="choice-btn w-full py-2 text-[11px] font-black border-2 rounded-xl transition-all ${val === opt ? 'active-choice' : 'bg-white border-slate-200'}">${opt.toUpperCase()}</button>`).join('')}</div></div>`;
                }
            }).join('');
        }
        function saveVal(fileName, qId, val) {
            const folder = benchmarkFolders[folderIndex];
            if (!evaluations[folder]) evaluations[folder] = {};
            if (!evaluations[folder][fileName]) evaluations[folder][fileName] = {};
            evaluations[folder][fileName][`Q${qId}`] = val;
            localStorage.setItem('eval_data', JSON.stringify(evaluations));
        }

        function markActive(btn) {
            btn.parentElement.querySelectorAll('.choice-btn').forEach(s => s.classList.remove('active-choice'));
            btn.classList.add('active-choice');
        }

        function changeLibrary(dir) {
            const nextIdx = fileIndex + dir;
            if (nextIdx >= 0 && nextIdx < libraryFiles.length) {
                fileIndex = nextIdx; loadLibrary();
                document.getElementById('task-container').scrollTop = 0;
            } else if (nextIdx >= libraryFiles.length) { showTransition(); }
        }

        function showTransition() {
            document.getElementById('loader-screen').style.display = 'flex';
            document.getElementById('loader-content').classList.add('hidden');
            document.getElementById('benchmark-transition').classList.remove('hidden');
            
            if (folderIndex >= benchmarkFolders.length - 1) {
                document.getElementById('trans-title').innerText = "ALL BENCHMARKS DONE";
                document.getElementById('benchmark-transition').querySelector('button').innerText = "EXPORT ALL RESULTS";
                document.getElementById('benchmark-transition').querySelector('button').onclick = exportJSON;
            }
        }

        function proceedToNextBenchmark() {
            document.getElementById('loader-content').classList.remove('hidden');
            document.getElementById('benchmark-transition').classList.add('hidden');
            loadBenchmarkFolder(folderIndex + 1);
        }

        function openDataModal(type) {
            const data = type === 'complex' ? currentComplexData : currentSimpleData;
            document.getElementById('modal-title').innerText = `${type.toUpperCase()} REFERENCE VIEW`;
            document.getElementById('modal-body').innerHTML = data.map((line, i) => `
                <div class="p-5 bg-slate-50 rounded-xl border border-slate-200 flex items-start gap-4 shadow-sm">
                    <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-black flex-shrink-0">${i+1}</span>
                    <p class="text-lg font-medium leading-relaxed italic text-slate-700">"${line}"</p>
                </div>
            `).join('');
            document.getElementById('data-modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('data-modal').style.display = 'none'; }
        function exportJSON() {
            const blob = new Blob([JSON.stringify(evaluations, null, 2)], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `final_evaluation.json`; a.click();
        }

        init();
    </script>
</body>
</html>